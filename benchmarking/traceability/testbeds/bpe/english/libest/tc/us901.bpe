▁/* ---------------- -- ---------------- ---------------- ---------------- ▁* ▁us 901 . c ▁- ▁Unit ▁Test s ▁for ▁User ▁S tory ▁ 901 ▁- ▁Server ▁cacerts ▁* ▁* ▁June , ▁2013 ▁* ▁* ▁Copy right ▁( c ) ▁2013 , ▁2016 ▁by ▁ cisco ▁System s , ▁Inc . ▁* ▁All ▁rights ▁ reserved . ▁* -- ---------------- ---------------- ---------------- ---------------- ▁*/ ▁# include ▁< s td io . h > ▁# if ndef ▁WI N 32 ▁# include ▁< uni s td . h > ▁# endif ▁# include ▁< est . h > ▁# include ▁< curl / curl . h > ▁# include ▁" curl _ util s . h " ▁# include ▁" test _ util s . h " ▁# include ▁" st _ server . h " ▁# include ▁< openssl / ssl . h > ▁# if def ▁HAV E _ C UNIT ▁# include ▁" CUnit / Basic . h " ▁# include ▁" CUnit / A utomat ed . h " ▁# endif ▁# define ▁US 901_ PKCS 10_ REQ ▁" MIICh jCCA W 4 CAQAw QT El MC MGA 1 UEAxM c cmV x IGJ 5 IGN saWV u dCB pbiB kZ W 1 v IHN 0\ n ZXAg Mj EY MBYG A 1 UEB RM P U El E Old pZG dl dCB T T joy MIIBIjANBgkq hk iG 9 w 0 BAQEF \ n AAOCAQ 8 AMIIBCgKCAQEA /6 JU Wp X XD wC kv WP DWO 0 y AND Qz FM x ro LE Ih 6/ vd Nw fR SG \ neN GC 0 ef c L 5 L 4 N xH ZO mO 14 yq MEM Gp Cy Hz 7 Ob 3 hh N Pu 0 K 8 1 g MU z Rq z w mm JH Xw Rq ob A \ ni 5 9 OQ Ek Ha P hI 1 T 4 Rk V nSY Z LO owS q on MZ jW bT 0 i qZ DY / RD 8 l 3 Gj H 3 gE IBMQ Fv 62 NT \ n 1 CS u 9 df HE g 7 6+ Dn JA h d ddU DJ D XO 3 A WI 5 s 7 zs Ll zB oP lg d 4 oK 5 K 1 wqE E 2 pq h nZ xe i \ nc 94 W Fq XQ 1 ky rW 0 P OV lQ + 32 mo W T QT FA 7 SQ E 2 uE F + GB X s RP a EO + FL Qj E 8 J HO ewL f / T \ nq X 0 ng yw nv x KR pK gu SBi c 31 WV ks wP s 8 E 34 pjj ZA vd x QIDAQABo AAwDQYJKoZIhvcN \ n AQEFBQADggEBA A ZX Vo orR xA v QP i MN DpR ZHh iD 5 O 2 Y d 7 APB Bz n V gR ll 1 H ML 5 dp gnu \ n XY 7 ZC Y wQ tx w NG YV tK Ja ZC i W 7 dWr Zh v nF 5 u a 3 wU r 9 R 2 Z No Lw VR 0 Z 9 Y 5 ww n 1 cJ rd SG \ nc Uu BN / 0 XB GI 6 g 6 f Ql DDI mQ oP SF 8 gy gc TC CH ba 7 Uv 0 i 8 oi Ci wf 5 UF + F 3 NY BoB L / PP \ n lO 2 zB EY NQ 65 + W 3 Yg fU yY P 0 C r 0 N yX g kz 3 Q h 2 Xa 2 e RFe W 56 oe jm c EaM jq 6 yx 7 WA C 2 X \ nk 3 w 1 G 6 Le 1 UI nz uen MS c N g nt 8 Fa I 43 e AIL M d LQ / Ek xc 30 f j xA 12 RD h / Yz DY i Ex Fv 0\ ndP d 4 o 5 u PK t 4 jR it vG i AP m / O CdX i YA wq i u 2 w =\ n " ▁# define ▁US 901_ ENROLL _ URL ▁" http s ://127.0.0.1: 29901 / . well - known / est / simpleenroll " ▁# define ▁US 901_ CACERT _ URL ▁" http s ://127.0.0.1: 29901 / . well - known / est / cacerts " ▁# define ▁US 901_ PKCS 10_ CT ▁" Content - Type : ▁application / pkcs 10" ▁# define ▁US 901_ UIDPWD _ GOOD ▁" estuser : estpwd " ▁# define ▁US 901_ UIDPWD _ BAD ▁" estuser : bogus " ▁# define ▁US 901_ SERVER _ PORT ▁ 29901 ▁# if ndef ▁WI N 32 ▁# define ▁US 901_ CACERTS ▁" CA / estCA / cacert . crt " ▁# define ▁US 901_ EXPLICIT _ CERT ▁" US 901/ explicit - cert . pem " ▁# define ▁US 901_ EXPLICIT _ KEY ▁" US 901/ explicit - key . pem " ▁# define ▁US 901_ IMPLICIT _ CERT ▁" US 901/ implicit - cert . pem " ▁# define ▁US 901_ IMPLICIT _ KEY ▁" US 901/ implicit - key . pem " ▁# define ▁US 901_ REVOKED _ CERT ▁" US 901/ revoked - cert . pem " ▁# define ▁US 901_ REVOKED _ KEY ▁" US 901/ revoked - key . pem " ▁# define ▁US 901_ SELF SIGN _ CERT ▁" US 901/ self signed - cert . pem " ▁# define ▁US 901_ SELF SIGN _ KEY ▁" US 901/ self signed - key . pem " ▁# define ▁US 901_ CACERT ▁" CA / estCA / cacert . crt " ▁# define ▁US 901_ EXT CERT ▁" CA / extCA / cacert . crt " ▁# define ▁US 901_ SERVER _ CERT ▁" CA / estCA / private / estserver cert and key . pem " ▁# define ▁US 901_ SERVER _ KEY ▁" CA / estCA / private / estserver cert and key . pem " ▁# define ▁US 901_ SERVER _ CERTKEY ▁" CA / estCA / private / estserver cert and key . pem " ▁static ▁char ▁test 5 _ outfile [ FILE NAME _ MAX ] ▁= ▁" US 901/ test 5 . crt "; ▁# else ▁# define ▁US 901_ CACERTS ▁" CA \\ estCA \\ cacert . crt " ▁# define ▁US 901_ EXPLICIT _ CERT ▁" US 901\\ explicit - cert . pem " ▁# define ▁US 901_ EXPLICIT _ KEY ▁" US 901\\ explicit - key . pem " ▁# define ▁US 901_ IMPLICIT _ CERT ▁" US 901\\ implicit - cert . pem " ▁# define ▁US 901_ IMPLICIT _ KEY ▁" US 901\\ implicit - key . pem " ▁# define ▁US 901_ REVOKED _ CERT ▁" US 901\\ revoked - cert . pem " ▁# define ▁US 901_ REVOKED _ KEY ▁" US 901\\ revoked - key . pem " ▁# define ▁US 901_ SELF SIGN _ CERT ▁" US 901\\ self signed - cert . pem " ▁# define ▁US 901_ SELF SIGN _ KEY ▁" US 901\\ self signed - key . pem " ▁# define ▁US 901_ CACERT ▁" CA \\ estCA \\ cacert . crt " ▁# define ▁US 901_ EXT CERT ▁" CA \\ extCA \\ cacert . crt " ▁# define ▁US 901_ SERVER _ CERT ▁" CA \\ estCA \\ private \\ estserver cert and key . pem " ▁# define ▁US 901_ SERVER _ KEY ▁" CA \\ estCA \\ private \\ estserver cert and key . pem " ▁# define ▁US 901_ SERVER _ CERTKEY ▁" CA \\ estCA \\ private / estserver cert and key . pem " ▁static ▁char ▁test 5 _ outfile [ FILE NAME _ MAX ] ▁= ▁" US 901\\ test 5 . crt "; ▁# endif ▁static ▁void ▁us 901_ clean ( void ) ▁{ ▁char ▁cmd [20 0 ] ; ▁ s printf ( cmd , ▁" rm ▁% s ", ▁test 5 _ outfile ); ▁system ( cmd ); ▁} ▁/* ▁* ▁This ▁routine ▁is ▁called ▁when ▁ CUnit ▁initialize s ▁this ▁test ▁* ▁suite . ▁This ▁can ▁be ▁used ▁to ▁allocate ▁data ▁or ▁open ▁any ▁* ▁ resources ▁required ▁for ▁all ▁the ▁test ▁cases . ▁*/ ▁static ▁int ▁us 901_ init _ suite ( void ) ▁{ ▁us 901_ clean (); ▁est _ init _ logger ( EST _ LOG _ L VL _ INFO , ▁NULL ); ▁return ▁0; ▁} ▁/* ▁* ▁This ▁routine ▁is ▁called ▁when ▁ CUnit ▁uninitialize s ▁this ▁test ▁* ▁suite . ▁This ▁can ▁be ▁used ▁to ▁de allocate ▁data ▁or ▁close ▁any ▁* ▁ resources ▁that ▁we re ▁used ▁for ▁the ▁test ▁cases . ▁*/ ▁static ▁int ▁us 901_ des tory _ suite ( void ) ▁{ ▁return ▁0; ▁} ▁/* ▁* ▁Start ▁the ▁appropriate ▁f la v or ▁of ▁st _ server ▁* ▁based ▁what ▁character ▁is ▁specified ▁* ▁B ▁- ▁Basic ▁auth ▁* ▁D ▁- ▁Digest ▁auth ▁* ▁C ▁- ▁CRL ▁checking ▁* ▁N ▁= ▁No ▁auth ▁*/ ▁static ▁int ▁us 901_ start _ server ( char ▁server _ type ) ▁{ ▁int ▁rv ; ▁switch ▁( server _ type ) ▁{ ▁case ▁' B ': ▁rv ▁= ▁st _ start ( US 901_ SERVER _ PORT , ▁US 901_ SERVER _ CERTKEY , ▁US 901_ SERVER _ CERTKEY , ▁" estrealm ", ▁" CA / estCA / cacert . crt ", ▁" CA / trustedcerts . crt ", ▁" CA / est Example CA . cnf ", ▁0, ▁0, ▁0); ▁st _ enable _ http _ basic _ auth (); ▁break ; ▁case ▁' D ': ▁rv ▁= ▁st _ start ( US 901_ SERVER _ PORT , ▁US 901_ SERVER _ CERTKEY , ▁US 901_ SERVER _ CERTKEY , ▁" estrealm ", ▁" CA / estCA / cacert . crt ", ▁" CA / trustedcerts . crt ", ▁" CA / est Example CA . cnf ", ▁0, ▁0, ▁0); ▁st _ enable _ http _ digest _ auth (); ▁break ; ▁case ▁' C ': ▁system ( ▁" openssl ▁ca ▁- config ▁CA / est Example CA . cnf ▁- gen crl ▁- out ▁CA / estCA / crl . pem "); ▁SL EEP (1); ▁system ( ▁" cat ▁CA / trustedcerts . crt ▁CA / estCA / crl . pem ▁> ▁US 901/ trustedcerts and crl . crt "); ▁SL EEP (1); ▁rv ▁= ▁st _ start ( US 901_ SERVER _ PORT , ▁US 901_ SERVER _ CERTKEY , ▁US 901_ SERVER _ CERTKEY , ▁" estrealm ", ▁" CA / estCA / cacert . crt ", ▁" US 901/ trustedcerts and crl . crt ", ▁" CA / est Example CA . cnf ", ▁0, ▁0, ▁0); ▁st _ enable _ crl (); ▁st _ disable _ http _ auth (); ▁break ; ▁case ▁' N ': ▁rv ▁= ▁st _ start ( US 901_ SERVER _ PORT , ▁US 901_ SERVER _ CERTKEY , ▁US 901_ SERVER _ CERTKEY , ▁" estrealm ", ▁" CA / estCA / cacert . crt ", ▁" CA / trustedcerts . crt ", ▁" CA / est Example CA . cnf ", ▁0, ▁0, ▁0); ▁st _ disable _ http _ auth (); ▁break ; ▁default : ▁rv ▁= ▁-1; ▁break ; ▁} ▁return ▁rv ; ▁} ▁/* ▁* ▁HTTP ▁Basic ▁auth ▁* ▁* ▁This ▁test ▁case ▁uses ▁libcurl ▁to ▁test ▁HTTP ▁Basic ▁* ▁authentication ▁is ▁working ▁on ▁the ▁EST ▁server . ▁* ▁It ▁must ▁use ▁a ▁simpleenroll ▁message ▁since ▁the ▁* ▁cacerts ▁message ▁does ▁not ▁require ▁the ▁client ▁* ▁to ▁be ▁authenticated . ▁The ▁EST ▁server ▁should ▁be ▁* ▁running ▁and ▁listing ▁to ▁port ▁808 8 ▁prior ▁to ▁this ▁* ▁test ▁being ▁run . ▁*/ ▁static ▁void ▁us 901_ test 1 ( void ) ▁{ ▁long ▁rv ; ▁int ▁st _ rv ; ▁st _ rv ▁= ▁us 901_ start _ server (' B '); ▁if ▁( st _ rv ) ▁{ ▁return ; ▁} ▁LOG _ FUNC _ NM ▁ ; ▁SL EEP (1); ▁rv ▁= ▁curl _ http _ post ( US 901_ ENROLL _ URL , ▁US 901_ PKCS 10_ CT , ▁US 901_ PKCS 10_ REQ , ▁US 901_ UIDPWD _ GOOD , ▁US 901_ CACERTS , ▁CURL AUTH _ BASIC , ▁NULL , ▁NULL , ▁NULL ); ▁/* ▁* ▁S ince ▁we ▁passed ▁in ▁a ▁valid ▁user ID / password , ▁* ▁we ▁expect ▁the ▁server ▁to ▁respond ▁with ▁200 ▁*/ ▁CU _ ASSERT ( rv ▁== ▁200 ); ▁st _ stop (); ▁SL EEP (1); ▁} ▁/* ▁* ▁HTTP ▁Basic ▁Auth ▁failure ▁* ▁* ▁This ▁test ▁case ▁uses ▁libcurl ▁to ▁test ▁HTTP ▁Basic ▁* ▁authentication ▁is ▁working ▁on ▁the ▁EST ▁server , ▁* ▁while ▁using ▁a ▁bogus ▁password . ▁* ▁It ▁must ▁use ▁a ▁simpleenroll ▁message ▁since ▁the ▁* ▁cacerts ▁message ▁does ▁not ▁require ▁the ▁client ▁* ▁to ▁be ▁authenticated . ▁The ▁EST ▁server ▁should ▁be ▁* ▁running ▁prior ▁to ▁this ▁test ▁being ▁run . ▁*/ ▁static ▁void ▁us 901_ test 2 ( void ) ▁{ ▁long ▁rv ; ▁int ▁st _ rv ; ▁st _ rv ▁= ▁us 901_ start _ server (' B '); ▁if ▁( st _ rv ) ▁{ ▁return ; ▁} ▁LOG _ FUNC _ NM ▁ ; ▁SL EEP (1); ▁rv ▁= ▁curl _ http _ post ( US 901_ ENROLL _ URL , ▁US 901_ PKCS 10_ CT , ▁US 901_ PKCS 10_ REQ , ▁US 901_ UIDPWD _ BAD , ▁US 901_ CACERTS , ▁CURL AUTH _ BASIC , ▁NULL , ▁NULL , ▁NULL ); ▁/* ▁* ▁S ince ▁we ▁passed ▁in ▁an ▁invalid ▁user ID / password , ▁* ▁we ▁expect ▁the ▁server ▁to ▁respond ▁with ▁400 ▁*/ ▁CU _ ASSERT ( rv ▁== ▁401 ); ▁st _ stop (); ▁SL EEP (1); ▁} ▁/* ▁* ▁HTTP ▁Digest ▁Auth ▁* ▁* ▁This ▁test ▁case ▁uses ▁libcurl ▁to ▁test ▁HTTP ▁Digest ▁* ▁authentication ▁is ▁working ▁on ▁the ▁EST ▁server . ▁* ▁It ▁must ▁use ▁a ▁simpleenroll ▁message ▁since ▁the ▁* ▁cacerts ▁message ▁does ▁not ▁require ▁the ▁client ▁* ▁to ▁be ▁authenticated . ▁The ▁EST ▁server ▁should ▁be ▁* ▁running ▁and ▁listen ing ▁to ▁port ▁808 7 ▁prior ▁to ▁this ▁* ▁test ▁being ▁run . ▁*/ ▁static ▁void ▁us 901_ test 3 ( void ) ▁{ ▁long ▁rv ; ▁int ▁st _ rv ; ▁st _ rv ▁= ▁us 901_ start _ server (' D '); ▁if ▁( st _ rv ) ▁{ ▁return ; ▁} ▁LOG _ FUNC _ NM ▁ ; ▁SL EEP (1); ▁rv ▁= ▁curl _ http _ post ( US 901_ ENROLL _ URL , ▁US 901_ PKCS 10_ CT , ▁US 901_ PKCS 10_ REQ , ▁US 901_ UIDPWD _ GOOD , ▁US 901_ CACERTS , ▁CURL AUTH _ DIGEST , ▁NULL , ▁NULL , ▁NULL ); ▁/* ▁* ▁S ince ▁we ▁passed ▁in ▁a ▁valid ▁user ID / password , ▁* ▁we ▁expect ▁the ▁server ▁to ▁respond ▁with ▁success ▁*/ ▁CU _ ASSERT ( rv ▁== ▁200 ); ▁st _ stop (); ▁SL EEP (1); ▁} ▁/* ▁* ▁HTTP ▁Digest ▁Auth ▁fail ▁* ▁* ▁This ▁test ▁case ▁uses ▁libcurl ▁to ▁test ▁HTTP ▁Digest ▁* ▁authentication ▁is ▁working ▁on ▁the ▁EST ▁server . ▁* ▁This ▁is ▁the ▁negative ▁test ▁case ▁for ▁Digest ▁auth . ▁* ▁It ▁must ▁use ▁a ▁simpleenroll ▁message ▁since ▁the ▁* ▁cacerts ▁message ▁does ▁not ▁require ▁the ▁client ▁* ▁to ▁be ▁authenticated . ▁The ▁EST ▁server ▁should ▁be ▁* ▁running ▁and ▁listen ing ▁to ▁port ▁808 7 ▁prior ▁to ▁this ▁* ▁test ▁being ▁run . ▁*/ ▁static ▁void ▁us 901_ test 4 ( void ) ▁{ ▁long ▁rv ; ▁int ▁st _ rv ; ▁st _ rv ▁= ▁us 901_ start _ server (' D '); ▁if ▁( st _ rv ) ▁{ ▁return ; ▁} ▁LOG _ FUNC _ NM ▁ ; ▁SL EEP (1); ▁rv ▁= ▁curl _ http _ post ( US 901_ ENROLL _ URL , ▁US 901_ PKCS 10_ CT , ▁US 901_ PKCS 10_ REQ , ▁US 901_ UIDPWD _ BAD , ▁US 901_ CACERTS , ▁CURL AUTH _ DIGEST , ▁NULL , ▁NULL , ▁NULL ); ▁/* ▁* ▁S ince ▁we ▁passed ▁in ▁an ▁invalid ▁user ID / password , ▁* ▁we ▁expect ▁the ▁server ▁to ▁respond ▁with ▁a ▁400 ▁*/ ▁CU _ ASSERT ( rv ▁== ▁401 ); ▁st _ stop (); ▁SL EEP (1); ▁} ▁static ▁ FILE ▁* outfile ; ▁static ▁size _ t ▁write _ func ( void ▁* ptr , ▁size _ t ▁size , ▁size _ t ▁nmemb , ▁void ▁* user data ) ▁{ ▁size _ t ▁written ; ▁written ▁= ▁f write ( ptr , ▁size , ▁nmemb , ▁outfile ); ▁return ▁written ; ▁} ▁/* ▁* ▁This ▁test ▁case ▁does ▁a ▁simple ▁cacerts ▁request ▁* ▁and ▁look s ▁for ▁the ▁HTTP ▁200 ▁response ▁code . ▁*/ ▁static ▁void ▁us 901_ test 5 ( void ) ▁{ ▁long ▁rv ; ▁char ▁cmd [20 0 ] ; ▁int ▁st _ rv ; ▁st _ rv ▁= ▁us 901_ start _ server (' D '); ▁if ▁( st _ rv ) ▁{ ▁return ; ▁} ▁LOG _ FUNC _ NM ▁ ; ▁SL EEP (1); ▁outfile ▁= ▁f open ( test 5 _ outfile , ▁" w "); ▁rv ▁= ▁curl _ http _ get ( US 901_ CACERT _ URL , ▁US 901_ CACERTS , ▁& write _ func ); ▁f close ( outfile ); ▁/* ▁* ▁we ▁expect ▁the ▁server ▁to ▁respond ▁with ▁a ▁200 ▁*/ ▁CU _ ASSERT ( rv ▁== ▁200 ); ▁ s printf ( cmd , ▁" openssl ▁base 64 ▁- d ▁- in ▁% s ▁| ▁openssl ▁pkcs 7 ▁- inform ▁DER ▁- text ▁- print _ certs ", ▁test 5 _ outfile ); ▁rv ▁= ▁system ( cmd ); ▁CU _ ASSERT ( rv ▁== ▁0); ▁st _ stop (); ▁SL EEP (1); ▁} ▁static ▁void ▁us 901_ test _ sslversion ( const ▁SSL _ METHOD ▁* m , ▁int ▁expect _ fail ) ▁{ ▁BIO ▁* conn ; ▁SSL ▁* ssl ; ▁SSL _ CTX ▁* ssl _ ctx ▁= ▁NULL ; ▁int ▁rv ; ▁int ▁st _ rv ; ▁st _ rv ▁= ▁us 901_ start _ server (' D '); ▁if ▁( st _ rv ) ▁{ ▁return ; ▁} ▁LOG _ FUNC _ NM ▁ ; ▁ssl _ ctx ▁= ▁SSL _ CTX _ new ( m ); ▁CU _ ASSERT ( ssl _ ctx ▁ != ▁NULL ); ▁/* ▁* ▁ Now ▁that ▁the ▁SSL ▁context ▁is ▁ready , ▁open ▁a ▁socket ▁* ▁with ▁the ▁server ▁and ▁bind ▁that ▁socket ▁to ▁the ▁context . ▁*/ ▁conn ▁= ▁open _ tcp _ socket _ ip v 4 (" 127 . 0 . 0 . 1", ▁" 29901 "); ▁CU _ ASSERT ( conn ▁ != ▁NULL ); ▁/* ▁* ▁C re a e a ▁SSL ▁session ▁context ▁*/ ▁ssl ▁= ▁SSL _ new ( ssl _ ctx ); ▁SSL _ set _ bio ( ssl , ▁conn , ▁conn ); ▁/* ▁* ▁ Now ▁that ▁we ▁have ▁everything ▁ready , ▁let ' s ▁initiate ▁the ▁TLS ▁* ▁handshake . ▁*/ ▁rv ▁= ▁SSL _ connect ( ssl ); ▁if ▁(! expect _ fail ) ▁{ ▁CU _ ASSERT ( rv ▁> ▁0); ▁} ▁else ▁{ ▁CU _ ASSERT ( rv ▁< = ▁0); ▁} ▁/* ▁* ▁Cleanup ▁all ▁the ▁data ▁*/ ▁SSL _ shutdown ( ssl ); ▁SSL _ free ( ssl ); ▁SSL _ CTX _ free ( ssl _ ctx ); ▁st _ stop (); ▁SL EEP (1); ▁} ▁/* ▁* ▁This ▁test ▁attempts ▁to ▁create ▁a ▁SSL ▁ 3.0 ▁connection ▁* ▁with ▁the ▁EST ▁server . ▁This ▁should ▁fail , ▁as ▁TLS ▁1.0 ▁* ▁is ▁not ▁allowed . ▁*/ ▁static ▁void ▁us 901_ test 6 ( void ) ▁{ ▁LOG _ FUNC _ NM ▁ ; ▁us 901_ test _ sslversion ( SSLv 3 _ client _ method (), ▁1); ▁} ▁/* ▁* ▁This ▁test ▁attempts ▁to ▁create ▁a ▁TLS ▁1.0 ▁connection ▁* ▁with ▁the ▁EST ▁server . ▁This ▁should ▁fail , ▁as ▁TLS ▁1.0 ▁* ▁is ▁not ▁allowed . ▁*/ ▁static ▁void ▁us 901_ test 7 ( void ) ▁{ ▁LOG _ FUNC _ NM ▁ ; ▁us 901_ test _ sslversion ( TLS v 1 _ client _ method (), ▁1); ▁} ▁/* ▁* ▁This ▁test ▁attempts ▁to ▁create ▁a ▁TLS ▁1.1 ▁connection ▁* ▁with ▁the ▁EST ▁server . ▁This ▁should ▁succeed . ▁*/ ▁static ▁void ▁us 901_ test 8 ( void ) ▁{ ▁LOG _ FUNC _ NM ▁ ; ▁us 901_ test _ sslversion ( TLS v 1 _ 1 _ client _ method (), ▁0); ▁} ▁/* ▁* ▁This ▁test ▁attempts ▁to ▁create ▁a ▁TLS ▁1.2 ▁connection ▁* ▁with ▁the ▁EST ▁server . ▁This ▁should ▁succeed . ▁*/ ▁static ▁void ▁us 901_ test 9 ( void ) ▁{ ▁LOG _ FUNC _ NM ▁ ; ▁us 901_ test _ sslversion ( TLS v 1 _ 2 _ client _ method (), ▁0); ▁} ▁/* ▁* ▁This ▁test ▁attempts ▁to ▁use ▁a ▁client ▁certificate ▁to ▁* ▁verify ▁the ▁TLS ▁client ▁authenti ait on ▁is ▁working . ▁* ▁The ▁certificate ▁used ▁is ▁signed ▁by ▁the ▁explicit ▁cert ▁* ▁chain . ▁This ▁should ▁succeed . ▁*/ ▁static ▁void ▁us 901_ test 10 ( void ) ▁{ ▁long ▁rv ; ▁int ▁st _ rv ; ▁st _ rv ▁= ▁us 901_ start _ server (' N '); ▁if ▁( st _ rv ) ▁{ ▁return ; ▁} ▁LOG _ FUNC _ NM ▁ ; ▁SL EEP (1); ▁rv ▁= ▁curl _ http _ post _ cert ( US 901_ ENROLL _ URL , ▁US 901_ PKCS 10_ CT , ▁US 901_ PKCS 10_ REQ , ▁US 901_ EXPLICIT _ CERT , ▁US 901_ EXPLICIT _ KEY , ▁US 901_ CACERTS , ▁NULL ); ▁/* ▁* ▁S ince ▁we ▁passed ▁in ▁a ▁valid ▁user ID / password , ▁* ▁we ▁expect ▁the ▁server ▁to ▁respond ▁with ▁200 ▁*/ ▁CU _ ASSERT ( rv ▁== ▁200 ); ▁st _ stop (); ▁SL EEP (1); ▁} ▁/* ▁* ▁This ▁test ▁attempts ▁to ▁use ▁a ▁client ▁certificate ▁to ▁* ▁verify ▁the ▁TLS ▁client ▁authenti ait on ▁is ▁working . ▁* ▁The ▁certificate ▁used ▁is ▁signed ▁by ▁the ▁implicit ▁cert ▁* ▁chain . ▁This ▁should ▁succeed . ▁*/ ▁static ▁void ▁us 901_ test 11 ( void ) ▁{ ▁long ▁rv ; ▁int ▁st _ rv ; ▁st _ rv ▁= ▁us 901_ start _ server (' N '); ▁if ▁( st _ rv ) ▁{ ▁return ; ▁} ▁LOG _ FUNC _ NM ▁ ; ▁SL EEP (1); ▁rv ▁= ▁curl _ http _ post _ cert ( US 901_ ENROLL _ URL , ▁US 901_ PKCS 10_ CT , ▁US 901_ PKCS 10_ REQ , ▁US 901_ IMPLICIT _ CERT , ▁US 901_ IMPLICIT _ KEY , ▁US 901_ CACERTS , ▁NULL ); ▁/* ▁* ▁S ince ▁we ▁passed ▁in ▁a ▁valid ▁user ID / password , ▁* ▁we ▁expect ▁the ▁server ▁to ▁respond ▁with ▁200 ▁*/ ▁CU _ ASSERT ( rv ▁== ▁200 ); ▁st _ stop (); ▁SL EEP (1); ▁} ▁/* ▁* ▁This ▁test ▁attempts ▁to ▁use ▁a ▁revoked ▁client ▁certificate ▁to ▁* ▁verify ▁CRL ▁checks ▁are ▁working ▁in ▁the ▁TLS ▁layer . ▁* ▁This ▁should ▁fail . ▁*/ ▁static ▁void ▁us 901_ test 12 ( void ) ▁{ ▁long ▁rv ; ▁int ▁st _ rv ; ▁st _ rv ▁= ▁us 901_ start _ server (' R '); ▁if ▁( st _ rv ) ▁{ ▁return ; ▁} ▁LOG _ FUNC _ NM ▁ ; ▁SL EEP (1); ▁rv ▁= ▁curl _ http _ post _ cert ( US 901_ ENROLL _ URL , ▁US 901_ PKCS 10_ CT , ▁US 901_ PKCS 10_ REQ , ▁US 901_ REVOKED _ CERT , ▁US 901_ REVOKED _ KEY , ▁US 901_ CACERTS , ▁NULL ); ▁/* ▁* ▁S ince ▁the ▁client ▁cert ▁has ▁been ▁revoked ▁the ▁TLS ▁handshake ▁* ▁will ▁fail . ▁The ▁EST ▁server ▁should ▁return ▁a ▁401 ▁response . ▁*/ ▁CU _ ASSERT ( rv ▁== ▁0); ▁st _ stop (); ▁} ▁/* ▁* ▁This ▁test ▁attempts ▁to ▁use ▁a ▁self - signed ▁client ▁certificate ▁to ▁* ▁verify ▁cert ▁chain ▁will ▁reject ▁a ▁cert ▁that ▁has ▁not ▁been ▁* ▁signed ▁by ▁a ▁valid ▁CA . ▁This ▁should ▁fail . ▁*/ ▁static ▁void ▁us 901_ test 13 ( void ) ▁{ ▁long ▁rv ; ▁int ▁st _ rv ; ▁st _ rv ▁= ▁us 901_ start _ server (' D '); ▁if ▁( st _ rv ) ▁{ ▁return ; ▁} ▁LOG _ FUNC _ NM ▁ ; ▁SL EEP (1); ▁rv ▁= ▁curl _ http _ post _ cert ( US 901_ ENROLL _ URL , ▁US 901_ PKCS 10_ CT , ▁US 901_ PKCS 10_ REQ , ▁US 901_ SELF SIGN _ CERT , ▁US 901_ SELF SIGN _ KEY , ▁US 901_ CACERTS , ▁NULL ); ▁/* ▁* ▁S ince ▁the ▁client ▁cert ▁is ▁not ▁signed ▁by ▁e i ther ▁the ▁local ▁CA ▁* ▁or ▁external ▁CA , ▁the ▁TLS ▁handshake ▁will ▁fail . ▁* ▁We ▁will ▁not ▁receive ▁an ▁HTTP ▁status ▁message ▁* ▁from ▁the ▁server . ▁*/ ▁CU _ ASSERT ( rv ▁== ▁0); ▁st _ stop (); ▁} ▁/* ▁* ▁TLS ▁ano nymo us ▁cipher ▁suites ▁disabled ▁* ▁* ▁This ▁test ▁case ▁uses ▁libcurl ▁to ▁test ▁that ▁the ▁* ▁EST ▁server ▁will ▁not ▁accept ▁ano nymo us ▁cipher ▁* ▁suites ▁from ▁the ▁client . ▁We ▁only ▁test ▁a ▁single ▁* ▁cipher ▁suite ▁here . ▁This ▁attempts ▁to ▁do ▁a ▁* ▁simple ▁enroll ▁with ▁the ▁server . ▁*/ ▁static ▁void ▁us 901_ test 14 ( void ) ▁{ ▁long ▁rv ; ▁int ▁st _ rv ; ▁st _ rv ▁= ▁us 901_ start _ server (' D '); ▁if ▁( st _ rv ) ▁{ ▁return ; ▁} ▁LOG _ FUNC _ NM ▁ ; ▁SL EEP (1); ▁rv ▁= ▁curl _ http _ post ( US 901_ ENROLL _ URL , ▁US 901_ PKCS 10_ CT , ▁US 901_ PKCS 10_ REQ , ▁US 901_ UIDPWD _ GOOD , ▁US 901_ CACERTS , ▁CURL AUTH _ BASIC , ▁" AD H - AES 128 - SHA 256 ", ▁NULL , ▁NULL ); ▁/* ▁* ▁TLS ▁handshake ▁should ▁have ▁failed , ▁curl ▁should ▁return ▁0 ▁*/ ▁CU _ ASSERT ( rv ▁== ▁0); ▁st _ stop (); ▁SL EEP (1); ▁} ▁/* ▁* ▁Null ▁HTTP ▁realm ▁when ▁initializ ing ▁server ▁*/ ▁static ▁void ▁us 901_ test 15 ( void ) ▁{ ▁un signed ▁char ▁* cacerts ▁= ▁NULL ; ▁int ▁cacerts _ len ▁= ▁0; ▁BIO ▁* certin , ▁* keyin ; ▁X 509 ▁* x ; ▁E VP _ PKEY ▁* priv _ key ; ▁int ▁rv ; ▁EST _ CTX ▁* ctx ; ▁LOG _ FUNC _ NM ▁ ; ▁/* ▁* ▁ Read ▁in ▁the ▁CA ▁certificates ▁*/ ▁cacerts _ len ▁= ▁read _ binary _ file ( US 901_ CACERT , ▁& cacerts ); ▁CU _ ASSERT ( cacerts _ len ▁> ▁0); ▁/* ▁* ▁ Read ▁the ▁server ▁cert ▁*/ ▁ certin ▁= ▁BIO _ new ( BIO _ s _ file _ internal ()); ▁rv ▁= ▁BIO _ read _ file name ( certin , ▁US 901_ SERVER _ CERT ); ▁CU _ ASSERT ( rv ▁> ▁0); ▁x ▁= ▁PEM _ read _ bio _ X 509( certin , ▁NULL , ▁NULL , ▁NULL ); ▁CU _ ASSERT ( x ▁ != ▁NULL ); ▁BIO _ free ( certin ); ▁/* ▁* ▁ Read ▁the ▁server ▁key ▁*/ ▁keyin ▁= ▁BIO _ new ( BIO _ s _ file _ internal ()); ▁rv ▁= ▁BIO _ read _ file name ( keyin , ▁US 901_ SERVER _ KEY ); ▁CU _ ASSERT ( rv ▁> ▁0); ▁priv _ key ▁= ▁PEM _ read _ bio _ PrivateKey ( keyin , ▁NULL , ▁NULL , ▁NULL ); ▁CU _ ASSERT ( priv _ key ▁ != ▁NULL ); ▁BIO _ free ( keyin ); ▁/* ▁* ▁Attempt ▁to ▁init ▁EST ▁server ▁using ▁NULL ▁realm ▁*/ ▁est _ init _ logger ( EST _ LOG _ L VL _ INFO , ▁NULL ); ▁ctx ▁= ▁est _ server _ init ( cacerts , ▁cacerts _ len , ▁cacerts , ▁cacerts _ len , ▁EST _ CERT _ FORMAT _ PEM , ▁NULL , ▁x , ▁priv _ key ); ▁CU _ ASSERT ( ctx ▁== ▁NULL ); ▁X 509_ free ( x ); ▁E VP _ PKEY _ free ( priv _ key ); ▁} ▁/* ▁* ▁Null ▁Server ▁certificate ▁when ▁initializ ing ▁server ▁*/ ▁static ▁void ▁us 901_ test 16 ( void ) ▁{ ▁un signed ▁char ▁* cacerts ▁= ▁NULL ; ▁int ▁cacerts _ len ▁= ▁0; ▁BIO ▁* keyin ; ▁E VP _ PKEY ▁* priv _ key ; ▁int ▁rv ; ▁EST _ CTX ▁* ctx ; ▁LOG _ FUNC _ NM ▁ ; ▁/* ▁* ▁ Read ▁in ▁the ▁CA ▁certificates ▁*/ ▁cacerts _ len ▁= ▁read _ binary _ file ( US 901_ CACERT , ▁& cacerts ); ▁CU _ ASSERT ( cacerts _ len ▁> ▁0); ▁/* ▁* ▁ Read ▁the ▁server ▁key ▁*/ ▁keyin ▁= ▁BIO _ new ( BIO _ s _ file _ internal ()); ▁rv ▁= ▁BIO _ read _ file name ( keyin , ▁US 901_ SERVER _ KEY ); ▁CU _ ASSERT ( rv ▁> ▁0); ▁priv _ key ▁= ▁PEM _ read _ bio _ PrivateKey ( keyin , ▁NULL , ▁NULL , ▁NULL ); ▁CU _ ASSERT ( priv _ key ▁ != ▁NULL ); ▁BIO _ free ( keyin ); ▁/* ▁* ▁Attempt ▁to ▁init ▁EST ▁server ▁using ▁NULL ▁server ▁key ▁*/ ▁est _ init _ logger ( EST _ LOG _ L VL _ INFO , ▁NULL ); ▁ctx ▁= ▁est _ server _ init ( cacerts , ▁cacerts _ len , ▁cacerts , ▁cacerts _ len , ▁EST _ CERT _ FORMAT _ PEM , ▁" test realm ", ▁NULL , ▁priv _ key ); ▁CU _ ASSERT ( ctx ▁== ▁NULL ); ▁E VP _ PKEY _ free ( priv _ key ); ▁} ▁/* ▁* ▁Null ▁Server ▁certificate ▁private ▁key ▁when ▁initializ ing ▁server ▁*/ ▁static ▁void ▁us 901_ test 17 ( void ) ▁{ ▁un signed ▁char ▁* cacerts ▁= ▁NULL ; ▁int ▁cacerts _ len ▁= ▁0; ▁BIO ▁* certin ; ▁X 509 ▁* x ; ▁int ▁rv ; ▁EST _ CTX ▁* ctx ; ▁LOG _ FUNC _ NM ▁ ; ▁/* ▁* ▁ Read ▁in ▁the ▁CA ▁certificates ▁*/ ▁cacerts _ len ▁= ▁read _ binary _ file ( US 901_ CACERT , ▁& cacerts ); ▁CU _ ASSERT ( cacerts _ len ▁> ▁0); ▁/* ▁* ▁ Read ▁the ▁server ▁cert ▁*/ ▁ certin ▁= ▁BIO _ new ( BIO _ s _ file _ internal ()); ▁rv ▁= ▁BIO _ read _ file name ( certin , ▁US 901_ SERVER _ CERT ); ▁CU _ ASSERT ( rv ▁> ▁0); ▁x ▁= ▁PEM _ read _ bio _ X 509( certin , ▁NULL , ▁NULL , ▁NULL ); ▁CU _ ASSERT ( x ▁ != ▁NULL ); ▁BIO _ free ( certin ); ▁/* ▁* ▁Attempt ▁to ▁init ▁EST ▁server ▁using ▁NULL ▁private ▁key ▁*/ ▁est _ init _ logger ( EST _ LOG _ L VL _ INFO , ▁NULL ); ▁ctx ▁= ▁est _ server _ init ( cacerts , ▁cacerts _ len , ▁cacerts , ▁cacerts _ len , ▁EST _ CERT _ FORMAT _ PEM , ▁" test realm ", ▁x , ▁NULL ); ▁CU _ ASSERT ( ctx ▁== ▁NULL ); ▁X 509_ free ( x ); ▁} ▁/* ▁* ▁Null ▁trusted ▁CA ▁chain ▁when ▁initializ ing ▁server ▁*/ ▁static ▁void ▁us 901_ test 18 ( void ) ▁{ ▁BIO ▁* certin , ▁* keyin ; ▁X 509 ▁* x ; ▁E VP _ PKEY ▁* priv _ key ; ▁int ▁rv ; ▁EST _ CTX ▁* ctx ; ▁LOG _ FUNC _ NM ▁ ; ▁/* ▁* ▁ Read ▁the ▁server ▁cert ▁*/ ▁ certin ▁= ▁BIO _ new ( BIO _ s _ file _ internal ()); ▁rv ▁= ▁BIO _ read _ file name ( certin , ▁US 901_ SERVER _ CERT ); ▁CU _ ASSERT ( rv ▁> ▁0); ▁x ▁= ▁PEM _ read _ bio _ X 509( certin , ▁NULL , ▁NULL , ▁NULL ); ▁CU _ ASSERT ( x ▁ != ▁NULL ); ▁BIO _ free ( certin ); ▁/* ▁* ▁ Read ▁the ▁server ▁key ▁*/ ▁keyin ▁= ▁BIO _ new ( BIO _ s _ file _ internal ()); ▁rv ▁= ▁BIO _ read _ file name ( keyin , ▁US 901_ SERVER _ KEY ); ▁CU _ ASSERT ( rv ▁> ▁0); ▁priv _ key ▁= ▁PEM _ read _ bio _ PrivateKey ( keyin , ▁NULL , ▁NULL , ▁NULL ); ▁CU _ ASSERT ( priv _ key ▁ != ▁NULL ); ▁BIO _ free ( keyin ); ▁/* ▁* ▁Attempt ▁to ▁init ▁EST ▁server ▁using ▁NULL ▁local ▁CA ▁chain ▁*/ ▁est _ init _ logger ( EST _ LOG _ L VL _ INFO , ▁NULL ); ▁ctx ▁= ▁est _ server _ init ( NULL , ▁0, ▁NULL , ▁0, ▁EST _ CERT _ FORMAT _ PEM , ▁" test realm ", ▁x , ▁priv _ key ); ▁CU _ ASSERT ( ctx ▁== ▁NULL ); ▁X 509_ free ( x ); ▁E VP _ PKEY _ free ( priv _ key ); ▁} ▁/* ▁* ▁Corrupt ed ▁CA ▁chain ▁when ▁initializ ing ▁server ▁*/ ▁static ▁void ▁us 901_ test 19 ( void ) ▁{ ▁BIO ▁* certin , ▁* keyin ; ▁X 509 ▁* x ; ▁E VP _ PKEY ▁* priv _ key ; ▁int ▁rv ; ▁EST _ CTX ▁* ctx ; ▁LOG _ FUNC _ NM ▁ ; ▁/* ▁* ▁ Read ▁the ▁server ▁cert ▁*/ ▁ certin ▁= ▁BIO _ new ( BIO _ s _ file _ internal ()); ▁rv ▁= ▁BIO _ read _ file name ( certin , ▁US 901_ SERVER _ CERT ); ▁CU _ ASSERT ( rv ▁> ▁0); ▁x ▁= ▁PEM _ read _ bio _ X 509( certin , ▁NULL , ▁NULL , ▁NULL ); ▁CU _ ASSERT ( x ▁ != ▁NULL ); ▁BIO _ free ( certin ); ▁/* ▁* ▁ Read ▁the ▁server ▁key ▁*/ ▁keyin ▁= ▁BIO _ new ( BIO _ s _ file _ internal ()); ▁rv ▁= ▁BIO _ read _ file name ( keyin , ▁US 901_ SERVER _ KEY ); ▁CU _ ASSERT ( rv ▁> ▁0); ▁priv _ key ▁= ▁PEM _ read _ bio _ PrivateKey ( keyin , ▁NULL , ▁NULL , ▁NULL ); ▁CU _ ASSERT ( priv _ key ▁ != ▁NULL ); ▁BIO _ free ( keyin ); ▁/* ▁* ▁Attempt ▁to ▁init ▁EST ▁server ▁a ▁corrupted ▁CA ▁chain ▁*/ ▁est _ init _ logger ( EST _ LOG _ L VL _ INFO , ▁NULL ); ▁ctx ▁= ▁est _ server _ init ( ( un signed ▁char *) ▁" B ogus ▁CA ▁chain ", ▁14, ▁( un signed ▁char *) ▁" B ogus ▁CA ▁chain ", ▁14, ▁EST _ CERT _ FORMAT _ PEM , ▁" test realm ", ▁x , ▁priv _ key ); ▁CU _ ASSERT ( ctx ▁== ▁NULL ); ▁X 509_ free ( x ); ▁E VP _ PKEY _ free ( priv _ key ); ▁} ▁/* ▁* ▁This ▁test ▁case ▁attempts ▁simple ▁cacerts ▁request ▁using ▁* ▁POST ▁instead ▁of ▁GET . ▁It ▁should ▁fail . ▁*/ ▁static ▁void ▁us 901_ test 20 ( void ) ▁{ ▁long ▁rv ; ▁int ▁st _ rv ; ▁st _ rv ▁= ▁us 901_ start _ server (' D '); ▁if ▁( st _ rv ) ▁{ ▁return ; ▁} ▁LOG _ FUNC _ NM ▁ ; ▁SL EEP (1); ▁outfile ▁= ▁f open ( test 5 _ outfile , ▁" w "); ▁rv ▁= ▁curl _ http _ post ( US 901_ CACERT _ URL , ▁US 901_ PKCS 10_ CT , ▁US 901_ PKCS 10_ REQ , ▁US 901_ UIDPWD _ GOOD , ▁US 901_ CACERTS , ▁CURL AUTH _ BASIC , ▁NULL , ▁NULL , ▁NULL ); ▁f close ( outfile ); ▁/* ▁* ▁we ▁expect ▁the ▁server ▁to ▁respond ▁with ▁a ▁400 ▁*/ ▁CU _ ASSERT ( rv ▁== ▁400 ); ▁st _ stop (); ▁SL EEP (1); ▁} ▁/* ▁* ▁This ▁test ▁attempts ▁to ▁use ▁a ▁client ▁certificate ▁to ▁* ▁verify ▁the ▁TLS ▁client ▁authenti ait on ▁is ▁working . ▁* ▁The ▁certificate ▁used ▁is ▁signed ▁by ▁the ▁explicit ▁cert ▁* ▁chain . ▁Valid ▁HTTP ▁authentication ▁credentials ▁are ▁* ▁also ▁provided . ▁This ▁should ▁succeed . ▁*/ ▁static ▁void ▁us 901_ test 21 ( void ) ▁{ ▁long ▁rv ; ▁int ▁st _ rv ; ▁st _ rv ▁= ▁us 901_ start _ server (' B '); ▁if ▁( st _ rv ) ▁{ ▁return ; ▁} ▁LOG _ FUNC _ NM ▁ ; ▁SL EEP (1); ▁rv ▁= ▁curl _ http _ post _ cert uid ( US 901_ ENROLL _ URL , ▁US 901_ PKCS 10_ CT , ▁US 901_ PKCS 10_ REQ , ▁US 901_ UIDPWD _ GOOD , ▁US 901_ EXPLICIT _ CERT , ▁US 901_ EXPLICIT _ KEY , ▁US 901_ CACERTS , ▁NULL ); ▁/* ▁* ▁S ince ▁we ▁passed ▁in ▁a ▁valid ▁user ID / password , ▁* ▁we ▁expect ▁the ▁server ▁to ▁respond ▁with ▁200 ▁*/ ▁CU _ ASSERT ( rv ▁== ▁200 ); ▁st _ stop (); ▁SL EEP (1); ▁} ▁/* ▁* ▁This ▁test ▁attempts ▁to ▁use ▁a ▁client ▁certificate ▁to ▁* ▁verify ▁the ▁TLS ▁client ▁authenti ait on ▁is ▁working . ▁* ▁The ▁certificate ▁used ▁is ▁signed ▁by ▁the ▁explicit ▁cert ▁* ▁chain . ▁I nvalid ▁HTTP ▁authentication ▁credentials ▁are ▁* ▁also ▁provided . ▁This ▁should ▁fail ▁with ▁a ▁401 ▁response . ▁*/ ▁static ▁void ▁us 901_ test 2 2 ( void ) ▁{ ▁long ▁rv ; ▁int ▁st _ rv ; ▁st _ rv ▁= ▁us 901_ start _ server (' D '); ▁if ▁( st _ rv ) ▁{ ▁return ; ▁} ▁LOG _ FUNC _ NM ▁ ; ▁SL EEP (1); ▁rv ▁= ▁curl _ http _ post _ cert uid ( US 901_ ENROLL _ URL , ▁US 901_ PKCS 10_ CT , ▁US 901_ PKCS 10_ REQ , ▁US 901_ UIDPWD _ BAD , ▁US 901_ EXPLICIT _ CERT , ▁US 901_ EXPLICIT _ KEY , ▁US 901_ CACERTS , ▁NULL ); ▁/* ▁* ▁S ince ▁we ▁passed ▁in ▁an ▁invalid ▁user ID / password , ▁* ▁we ▁expect ▁the ▁server ▁to ▁respond ▁with ▁401 ▁*/ ▁CU _ ASSERT ( rv ▁== ▁401 ); ▁st _ stop (); ▁SL EEP (1); ▁} ▁/* ▁* ▁This ▁test ▁attempts ▁to ▁enroll ▁without ▁using ▁a ▁certificate ▁* ▁to ▁identity ▁the ▁client , ▁while ▁using ▁a ▁good ▁user ▁ID / pwd . ▁* ▁How ever , ▁the ▁EST ▁server ▁is ▁set up ▁to ▁only ▁perform ▁* ▁certificate ▁authentication ▁( HTTP ▁auth ▁disabled ) . ▁* ▁This ▁should ▁fail ▁with ▁a ▁401 ▁response . ▁*/ ▁static ▁void ▁us 901_ test 2 3 ( void ) ▁{ ▁long ▁rv ; ▁int ▁st _ rv ; ▁st _ rv ▁= ▁us 901_ start _ server (' N '); ▁if ▁( st _ rv ) ▁{ ▁return ; ▁} ▁LOG _ FUNC _ NM ▁ ; ▁SL EEP (1); ▁rv ▁= ▁curl _ http _ post ( US 901_ ENROLL _ URL , ▁US 901_ PKCS 10_ CT , ▁US 901_ PKCS 10_ REQ , ▁US 901_ UIDPWD _ GOOD , ▁US 901_ CACERTS , ▁CURL AUTH _ BASIC , ▁NULL , ▁NULL , ▁NULL ); ▁/* ▁* ▁S ince ▁we ▁passed ▁in ▁an ▁invalid ▁user ID / password , ▁* ▁we ▁expect ▁the ▁server ▁to ▁respond ▁with ▁401 ▁*/ ▁CU _ ASSERT ( rv ▁== ▁401 ); ▁st _ stop (); ▁SL EEP (1); ▁} ▁/* ▁The ▁main () ▁function ▁for ▁setting ▁up ▁and ▁running ▁the ▁tests . ▁* ▁Returns ▁a ▁CU E _ SUCCESS ▁on ▁successful ▁running , ▁another ▁* ▁ CUnit ▁error ▁code ▁on ▁failure . ▁*/ ▁int ▁us 901_ add _ suite ( void ) ▁{ ▁# if def ▁HAV E _ C UNIT ▁CU _ pSuite ▁pSuite ▁= ▁NULL ; ▁/* ▁add ▁a ▁suite ▁to ▁the ▁ registry ▁*/ ▁pSuite ▁= ▁CU _ add _ suite (" us 901_ srv _ cacerts ", ▁us 901_ init _ suite , ▁us 901_ des tory _ suite ); ▁if ▁( NULL ▁== ▁pSuite ) ▁{ ▁CU _ cleanup _ registry (); ▁return ▁CU _ get _ error (); ▁} ▁/* ▁add ▁the ▁tests ▁to ▁the ▁suite ▁*/ ▁/* ▁NOTE ▁- ▁OR DER ▁IS ▁ IMPORTANT ▁- ▁MUST ▁TEST ▁f read () ▁ AFTER ▁f printf () ▁*/ ▁if ▁( ( NULL ▁== ▁CU _ add _ test ( pSuite , ▁" HTTP ▁Basic ▁Auth ", ▁us 901_ test 1)) ▁|| ▁( NULL ▁== ▁CU _ add _ test ( pSuite , ▁" HTTP ▁Basic ▁Auth ▁Fail ", ▁us 901_ test 2)) ▁|| ▁( NULL ▁== ▁CU _ add _ test ( pSuite , ▁" HTTP ▁Digest ▁Auth ", ▁us 901_ test 3)) ▁|| ▁( NULL ▁== ▁CU _ add _ test ( pSuite , ▁" HTTP ▁Digest ▁Auth ▁Fail ", ▁us 901_ test 4)) ▁|| ▁( NULL ▁== ▁CU _ add _ test ( pSuite , ▁" Get ▁CA ▁Certificates ", ▁us 901_ test 5)) ▁|| ▁( NULL ▁== ▁CU _ add _ test ( pSuite , ▁" SSL ▁ 3.0 ▁Fail ", ▁us 901_ test 6)) ▁|| ▁( NULL ▁== ▁CU _ add _ test ( pSuite , ▁" TLS ▁1.0 ▁Fail ", ▁us 901_ test 7)) ▁|| ▁( NULL ▁== ▁CU _ add _ test ( pSuite , ▁" TLS ▁1.1 ", ▁us 901_ test 8)) ▁|| ▁( NULL ▁== ▁CU _ add _ test ( pSuite , ▁" TLS ▁1.2 ", ▁us 901_ test 9)) ▁|| ▁( NULL ▁== ▁CU _ add _ test ( pSuite , ▁" Certificate ▁auth ▁- ▁explicit ▁cert ▁chain ", ▁us 901_ test 10)) ▁|| ▁( NULL ▁== ▁CU _ add _ test ( pSuite , ▁" Certificate ▁auth ▁- ▁implicit ▁cert ▁chain ", ▁us 901_ test 11)) ▁|| ▁( NULL ▁== ▁CU _ add _ test ( pSuite , ▁" Certificate ▁auth ▁- ▁revoked ▁cert ", ▁us 901_ test 12)) ▁|| ▁( NULL ▁== ▁CU _ add _ test ( pSuite , ▁" Certificate ▁auth ▁- ▁self - signed ▁cert ", ▁us 901_ test 1 3)) ▁|| ▁( NULL ▁== ▁CU _ add _ test ( pSuite , ▁" An on ▁cipher ▁suite ▁disabled ", ▁us 901_ test 1 4)) ▁|| ▁( NULL ▁== ▁CU _ add _ test ( pSuite , ▁" NULL ▁ Realm ", ▁us 901_ test 1 5)) ▁|| ▁( NULL ▁== ▁CU _ add _ test ( pSuite , ▁" NULL ▁server ▁cert ", ▁us 901_ test 16)) ▁|| ▁( NULL ▁== ▁CU _ add _ test ( pSuite , ▁" NULL ▁server ▁key ", ▁us 901_ test 17)) ▁|| ▁( NULL ▁== ▁CU _ add _ test ( pSuite , ▁" NULL ▁local ▁CA ▁chain ", ▁us 901_ test 18)) ▁|| ▁( NULL ▁== ▁CU _ add _ test ( pSuite , ▁" Corrupt ed ▁local ▁CA ▁chain ", ▁us 901_ test 1 9)) ▁|| ▁( NULL ▁== ▁CU _ add _ test ( pSuite , ▁" HTTP ▁POST ▁cacerts ", ▁us 901_ test 20 )) ▁|| ▁( NULL ▁== ▁CU _ add _ test ( pSuite , ▁" SimpleEnroll ▁- ▁good ▁HTTP ▁auth / good ▁Cert ", ▁us 901_ test 2 1)) ▁|| ▁( NULL ▁== ▁CU _ add _ test ( pSuite , ▁" SimpleEnroll ▁- ▁bad ▁HTTP ▁auth / good ▁Cert ", ▁us 901_ test 2 2)) ▁|| ▁( NULL ▁== ▁CU _ add _ test ( pSuite , ▁" SimpleEnroll ▁- ▁no ▁HTTP ▁auth / no ▁Cert ", ▁us 901_ test 2 3)) ) ▁{ ▁CU _ cleanup _ registry (); ▁return ▁CU _ get _ error (); ▁} ▁return ▁CU E _ SUCCESS ; ▁# endif ▁}